-- 连表更新，一张表中的多条某个字段求和更新到另一张表中
UPDATE p_player_rs A 
INNER JOIN ( SELECT  SUM(StarCount) AS StarCount,PlayerID FROM `p_copy_chapter` GROUP BY PlayerID) AS B
  ON B.PlayerID = A.PlayerID
SET A.CopyStars = B.StarCount;

-- 两张表连接插入
-- 增加临时b表
DROP TABLE IF EXISTS `b_copy_chapter_model`;
CREATE TABLE `b_copy_chapter_model` (
  `ID` int(10) unsigned NOT NULL COMMENT '#模型ID',
  `Name` varchar(256) NOT NULL COMMENT '模型名称',
  `Stars` int(10) unsigned NOT NULL COMMENT '总的星数',
  `NeedPlayerLv` int(10) unsigned NOT NULL COMMENT '所需玩家等级',
  `OutPutOneHour` varchar(256) NOT NULL COMMENT '产出资源/小时',
  `MajestyPowerID` int(10) unsigned NOT NULL COMMENT '产出天赋碎片ID',
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='普通副本章节表';

insert  into `b_copy_chapter_model`(`ID`,`Name`,`Stars`,`NeedPlayerLv`,`OutPutOneHour`,`MajestyPowerID`) values (101,'巨鹿',12,1,'1114,0,15',19021101),(102,'下邳',15,1,'1113,0,45',19021102),(103,'曲阳',18,1,'1112,0,90',19021103),(104,'阳城',18,1,'1114,0,60',19021104),(105,'广宗',18,1,'1113,0,115',19022101),(106,'新城',18,1,'1112,0,180',19022102),(107,'武威',18,1,'1114,0,105',19022103),(108,'汜水关',18,1,'1113,0,180',19022104),(109,'庐江',18,1,'1112,0,270',19023101),(110,'于阳',18,1,'1114,0,150',19023102),(111,'虎牢关',18,1,'1113,0,250',19023103),(112,'襄阳',18,1,'1112,0,360',19023104),(113,'磐河',18,1,'1114,0,195',19024101),(114,'长陵',18,34,'1113,0,315',19024102),(115,'临洮',18,35,'1112,0,450',19024103),(116,'陈留',18,36,'1114,0,240',19024104),(117,'山阳',18,37,'1113,0,385',19025101),(118,'茂陵',18,38,'1112,0,540',19025102),(119,'北海',18,39,'1114,0,285',19025103),(120,'淯水',18,40,'1113,0,450',19025104),(121,'安平',18,42,'1112,0,630',19021201),(122,'谯国',18,44,'1114,0,330',19021202),(123,'辽西',18,46,'1113,0,520',19021203),(124,'许昌',18,48,'1112,0,720',19021204),(125,'涿郡',18,50,'1114,0,375',19022201),(126,'东莱',18,52,'1113,0,585',19022202),(127,'渤海',18,54,'1112,0,810',19022203),(128,'沛国',18,56,'1114,0,420',19022204),(129,'辕门',18,58,'1113,0,655',19023201),(130,'宛城',18,60,'1112,0,900',19023202),(131,'汝阳',18,62,'1114,0,465',19023203),(132,'广陵',18,64,'1113,0,720',19023204),(133,'徐州',18,66,'1112,0,990',19024201),(134,'吞吐山',18,68,'1114,0,510',19024202),(135,'白马县',18,70,'1113,0,790',19024203),(136,'延津',18,72,'1112,0,1080',19024204),(137,'汝南',18,74,'1114,0,555',19025201),(138,'东岭',18,76,'1113,0,855',19025202),(139,'荥阳',18,78,'1112,0,1170',19025203),(140,'古城',18,80,'1114,0,600',19025204),(141,'滑州',18,82,'1113,0,925',19021301),(142,'济南',18,84,'1112,0,1260',19021302),(143,'吴郡',18,86,'1114,0,645',19021303),(144,'官渡',18,88,'1113,0,990',19021304),(145,'乌巢',18,90,'1112,0,1350',19022301),(146,'建平',18,92,'1114,0,690',19022302),(147,'仓亭',18,94,'1113,0,1060',19022303),(148,'戈阳',18,96,'1112,0,1440',19022304),(149,'江夏',18,98,'1114,0,735',19023301),(150,'长沙',18,100,'1113,0,1125',19023302),(151,'樊城',18,102,'1112,0,1530',19023303),(152,'南阳',18,104,'1114,0,780',19023304),(153,'夏口',18,106,'1113,0,1195',19024301),(154,'零陵',18,108,'1112,0,1620',19024302),(155,'博望坡',18,110,'1114,0,825',19024303),(156,'新野',18,112,'1113,0,1260',19024304),(157,'江阳',18,114,'1112,0,1710',19025301),(158,'贵阳',18,116,'1114,0,870',19025302),(159,'上庸',18,118,'1113,0,1330',19025303),(160,'观阳',18,120,'1112,0,1800',19025304);

-- 插入碎片列
INSERT INTO `p_majestypower_debris`(SELECT A.PlayerID,GROUP_CONCAT( B.`MajestyPowerID` SEPARATOR ',') FROM ( SELECT PlayerID,chapterID FROM `p_copy_chapter` WHERE IsPass=1) A INNER JOIN  `b_copy_chapter_model` AS B ON A.chapterID=B.`ID` GROUP BY A.PlayerID);

-- 删除临时表
DROP TABLE IF EXISTS `b_copy_chapter_model`;


--  后宫未激活女将ID返还 --
DROP TABLE IF EXISTS harem_temp; 
CREATE TABLE `harem_temp` (
  `ID` INT(10) UNSIGNED NOT NULL COMMENT '#女将ID',
  `NeedGoodsID` VARCHAR(1024) NOT NULL COMMENT '激活所需商品ID',
  `NeedFateNum` INT(10) UNSIGNED NOT NULL COMMENT '激活所需缘分值',
  PRIMARY KEY (`ID`)
) ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='后宫处理返还';
INSERT  INTO `harem_temp`(`ID`,`NeedFateNum`,`NeedGoodsID`) VALUES(16010001, 8800, '1414,14140001,100'),(16010003, 8200, '1414,14140002,100'),(16010004, 6300, '1414,14140003,100'),(16010005, 7600, '1414,14140004,100'),(16010008, 4400, '1414,14140027,100'),(16010009, 6900, '1414,14140005,100'),(16010010, 6900, '1414,14140011,100'),(16010011, 900,  '1414,14140021,100'),(16010012, 6300, '1414,14140022,100'),(16010016, 7600, '1414,14140025,100'),(16010018, 8800, '1414,14140014,100'),(16010019, 3800, '1414,14140028,100'),(16010020, 6900, '1414,14140006,100'),(16010021, 6300, '1414,14140015,100'),(16010022, 50,   '1414,14140024,100'),(16010023, 6900, '1414,14140026,100'),(16010024, 8200, '1414,14140017,100'),(16010026, 6300, '1414,14140018,100'),(16010027, 3800, '1414,14140029,100'),(16010028, 4400, '1414,14140030,100'),(16010029, 4400, '1414,14140031,100'),(16010030, 3800, '1414,14140032,100'),(16010031, 4400, '1414,14140019,100'),(16010032, 3800, '1414,14140008,100');

INSERT INTO p_email
SELECT  UUID(),a.playerid,'00000000-0000-0000-0000-000000000000',22,'后宫调整返还','{"Des":"主公，由于后宫功能进行调整，在此会将您后宫未激活的佳丽按照结缘比例返还对应的佳丽碎片数量，由此造成的不便，还希望主公多多谅解。","SenderName":"系统邮件"}',CONCAT(SUBSTRING_INDEX(b.NeedGoodsID, ',', 2),',',CEIL(a.BondExp/b.NeedFateNum * SUBSTRING_INDEX(b.NeedGoodsID, ',', -1))),FALSE,FALSE,NOW(),NOW(),DATE_ADD(NOW(), INTERVAL 30 DAY),NOW(),FALSE 
FROM `p_harem_natalie` a 
INNER JOIN harem_temp b ON a.NatalieModelID=b.ID WHERE a.IsActivated=0;
DROP TABLE IF EXISTS harem_temp; 

--  国家科技返还 --
DROP TABLE IF EXISTS TitleTemp; 
CREATE TABLE `TitleTemp` (
  `Lv` INT(10) UNSIGNED NOT NULL COMMENT '#等级',
  `Reward` VARCHAR(1024) NOT NULL COMMENT '奖励',
  PRIMARY KEY (`Lv`)
) ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='国家科技返还';
INSERT  INTO `TitleTemp`(`Lv`,`Reward`) VALUES(2,'1117,0,15000'),(3,'1117,0,50000||1405,14050032,2||1405,14050033,2||1405,14050034,2'),(4,'1117,0,115000||1405,14050032,5||1405,14050033,5||1405,14050034,5'),(5,'1117,0,215000||1405,14050032,9||1405,14050033,9||1405,14050034,9'),(6,'1117,0,360000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,6||1405,14050036,6||1405,14050037,6||1405,14050038,6'),(7,'1117,0,560000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,14||1405,14050036,14||1405,14050037,14||1405,14050038,14'),(8,'1117,0,820000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24'),(9,'1117,0,1150000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,12||1405,14050040,12||1405,14050041,12||1405,14050042,12'),(10,'1117,0,1560000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,26||1405,14050040,26||1405,14050041,26||1405,14050042,26'),(11,'1117,0,2055000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,42||1405,14050040,42||1405,14050041,42||1405,14050042,42'),(12,'1117,0,2645000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,42||1405,14050040,42||1405,14050041,42||1405,14050042,42||1405,14050110,18||1405,14050111,18||1405,14050112,18||1405,14050113,18'),(13,'1117,0,3335000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,42||1405,14050040,42||1405,14050041,42||1405,14050042,42||1405,14050110,38||1405,14050111,38||1405,14050112,38||1405,14050113,38'),(14,'1117,0,4135000||1405,14050032,9||1405,14050033,9||1405,14050034,9||1405,14050035,24||1405,14050036,24||1405,14050037,24||1405,14050038,24||1405,14050039,42||1405,14050040,42||1405,14050041,42||1405,14050042,42||1405,14050110,62||1405,14050111,62||1405,14050112,62||1405,14050113,62');

-- 国家科技返还
INSERT INTO p_email
SELECT  UUID(),a.playerid,'00000000-0000-0000-0000-000000000000',22,'国家科技资源返还','{"Des":"主公，由于国家科技功能调整，在此会将您提升此国家科技花费的资源进行返还，由此造成的不便，还希望主公多多谅解。","SenderName":"系统邮件"}',b.Reward,FALSE,FALSE,NOW(),NOW(),DATE_ADD(NOW(), INTERVAL 30 DAY),NOW(),FALSE 
FROM `p_country` a 
INNER JOIN TitleTemp b ON a.TitleLv=b.Lv;

DROP TABLE IF EXISTS TitleTemp; 

-- 查询两张表中不相同的数据，并且将不同的数据插入到另一张表中，采用临时表的形式
CREATE TABLE `b_modle_temp` (
  `NatalieModelID` INT(10) UNSIGNED NOT NULL COMMENT '女将模型ID',
  PRIMARY KEY (`NatalieModelID`)
) ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='后宫女将信息';
INSERT INTO b_modle_temp VALUES (16010011),(16010028),(16010022),(16010027),(16010008),(16010019),(16010029),(16010030);

CREATE TABLE `p_harem_natalie_temp` (
  `PlayerID` CHAR(36) NOT NULL COMMENT '玩家ID',
  `NatalieModelID` INT(10) UNSIGNED NOT NULL COMMENT '女将模型ID',
  PRIMARY KEY (`PlayerID`,`NatalieModelID`)
) ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='后宫女将信息';

INSERT INTO p_harem_natalie_temp (SELECT a.playerid,b.NatalieModelID FROM (SELECT playerid FROM p_harem_natalie GROUP BY playerid) AS a,b_modle_temp AS b);
INSERT INTO p_harem_natalie (SELECT a.playerid,UUID(),a.NatalieModelID ,1,'00000000-0000-0000-0000-000000000000',NOW() FROM p_harem_natalie_temp AS a WHERE NOT EXISTS (SELECT * FROM p_harem_natalie WHERE playerid=a.playerid AND NatalieModelID=a.NatalieModelID))

-- 临时表删除
DROP TABLE IF EXISTS b_modle_temp;
DROP TABLE IF EXISTS p_harem_natalie_temp; 



